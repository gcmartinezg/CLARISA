FROM node:lts-alpine3.19 as dev-deps
WORKDIR /app
COPY package.json package.json
RUN npm i


FROM node:lts-alpine3.19 as builder
WORKDIR /app
COPY --from=dev-deps /app/node_modules ./node_modules
COPY . .
# RUN yarn test
RUN npm run build

FROM node:lts-alpine3.19 as prod-deps
WORKDIR /app
COPY package.json package.json
RUN npm i --only=prod


FROM node:lts-alpine3.19 as LOCAL
EXPOSE 3000
WORKDIR /app
COPY .env .env
ENV APP_PORT=${APP_PORT}
ENV APP_PROFILE=${APP_PROFILE}
ENV DB_HOST=${DB_HOST}
ENV DB_PORT=${DB_PORT}
ENV DB_USER=${DB_USER}
ENV DB_PASS=${DB_PASS}
ENV DB_NAME=${DB_NAME}
ENV AD_URL=${AD_URL}
ENV AD_BASEDN=${AD_BASEDN}
ENV AD_DOMAIN=${AD_DOMAIN}
ENV JWT_SECRET=${JWT_SECRET}
ENV JWT_TIME=${JWT_TIME}
ENV BCRYPT_SALT_ROUNDS=${BCRYPT_SALT_ROUNDS}
ENV SUPPORT_EMAIL=${SUPPORT_EMAIL}
ENV PREFERRED_EMAIL_HOST=${PREFERRED_EMAIL_HOST}
ENV PREFERRED_EMAIL_PORT=${PREFERRED_EMAIL_PORT}
ENV PREFERRED_EMAIL_USERNAME=${PREFERRED_EMAIL_USERNAME}
ENV PREFERRED_EMAIL_PASSWORD=${PREFERRED_EMAIL_PASSWORD}
ENV ALTERNATIVE_EMAIL_HOST=${ALTERNATIVE_EMAIL_HOST}
ENV ALTERNATIVE_EMAIL_PORT=${ALTERNATIVE_EMAIL_PORT}
ENV ALTERNATIVE_EMAIL_USERNAME=${ALTERNATIVE_EMAIL_USERNAME}
ENV ALTERNATIVE_EMAIL_PASSWORD=${ALTERNATIVE_EMAIL_PASSWORD}
ENV OST_URL=${OST_URL}
ENV OST_USER=${OST_USER}
ENV OST_PASS=${OST_PASS}
ENV QA_URL=${QA_URL}
ENV TOC_URL=${TOC_URL}
ENV REPORTING_URL=${REPORTING_URL}
COPY --from=prod-deps /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist

CMD [ "node","dist/src/main.js"]